<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Part 2 | Body 1 ビルダー（理由→たとえば クイズ + TTS）</title>
<style>
  :root{ --bg:#f7f7fb; --card:#fff; --ink:#0f172a; --muted:#6b7280; --accent:#2563eb; --ring:#93c5fd; --ok:#16a34a; --bad:#dc2626; --radius:16px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,"Noto Sans JP",Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .container{max-width:900px;margin:0 auto;padding:clamp(16px,3vw,28px)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:10px}
  h1{font-size:clamp(20px,4.6vw,28px);margin:0}
  .toolbar{display:flex;gap:8px}
  button{border:0;background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.08)}
  button.secondary{background:#e5e7eb;color:#111827}
  button.primary{background:var(--accent);color:#fff}
  button.slim{padding:6px 10px;border-radius:10px;font-size:12px}
  button:focus{outline:2px solid var(--ring);outline-offset:2px}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#e0e7ff;color:#3730a3;font-weight:700;padding:4px 10px;border-radius:999px;font-size:12px}
  .muted{color:var(--muted)} .hr{height:1px;background:#e5e7eb;margin:12px 0}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(2,6,23,.06)}
  .row{display:grid;gap:10px}
  .steps{display:flex;gap:6px;flex-wrap:wrap;margin:4px 0 2px}
  .pill{background:#eef2ff;color:#1e293b;font-weight:700;padding:3px 10px;border-radius:999px;font-size:12px}
  .pill.active{background:#2563eb;color:#fff}
  .pill.done{background:#dcfce7;color:#065f46}
  .choice-wrap{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:10px 12px;border:1px solid #e5e7eb;border-radius:999px;cursor:pointer;background:#fff;transition:transform .08s ease, background .15s ease, border-color .15s ease;color:#111}
  .chip:hover{transform:translateY(-1px)}
  .chip[disabled]{opacity:.55;cursor:not-allowed;transform:none}
  .chip.ok.selected{background:#dcfce7;border-color:#86efac}
  .chip.bad.flash{background:#fee2e2;border-color:#fecaca}
  .chip.selected{ outline:2px solid var(--accent); background:#eff6ff; border-color:#bfdbfe }

  .progress{height:6px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#2563eb);transition:width .25s ease}
  .result{font-weight:700}.result.ok{color:var(--ok)}.result.bad{color:var(--bad)}
  .copy-area{white-space:pre-wrap;background:#0b1020;color:#e2e8f0;padding:12px;border-radius:12px;font-size:14px}

  /* 見出し（罫線＋電球） */
  .topic-head{display:grid;gap:6px;margin-top:6px}
  .topic-title{font-weight:800;font-size:22px}
  .topic-subline{display:flex;align-items:center;gap:8px;color:#334155;font-weight:700}
  .topic-subline::before,.topic-subline::after{content:"";flex:1;height:1.5px;background:#e5e7eb;border-radius:999px}

  /* Preview（下に配置） */
  .preview{background:#f1f5f9;border-radius:12px;padding:12px;font-size:15px;margin-top:6px}
  .preview-actions{border-top:1px dashed #cbd5e1; margin-top:8px; padding-top:8px; display:flex; align-items:center; gap:12px; flex-wrap:wrap}
  .btn-icon{width:40px;height:40px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;background:#e5e7eb;color:#111827}

  .okwrap{display:none;align-items:center;gap:10px;margin-top:8px}

  /* STEP1の理由を表示しながらSTEP2 */
  .reason-group{display:none;gap:8px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .summary-line{display:flex;align-items:center;gap:10px}
  .summary-line .tag{background:#dcfce7;color:#065f46;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .subhead{font-weight:700;color:#334155;font-size:14px;margin-top:2px}

  /* まとめのチェックリスト */
  .ans-item{display:flex;align-items:center;gap:10px;padding:8px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;justify-content:space-between}
  .ans-left{display:flex;align-items:center;gap:10px}
  .ans-item.disabled{opacity:.6}
  .ans-title{font-weight:700}
  .ans-note{color:var(--muted);font-size:12px}

  @media print{ header,.toolbar,details{display:none!important} body{background:#fff} .card{box-shadow:none;border:1px solid #e5e7eb} }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>🟨 Part 2｜Body 1 ビルダー（クイズ）</h1>
    <div class="toolbar">
      <button id="btn-reset" class="secondary">↺ リセット</button>
      <button id="btn-print" class="secondary">🖨️ 印刷</button>
    </div>
  </header>

  <div class="progress"><div id="bar" class="bar"></div></div>

  <div id="quiz" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div class="badge">Q<span id="qnum">1</span> / <span id="qtotal">3</span></div>
      <div class="muted">正解数：<b id="score">0</b></div>
    </div>

    <div class="hr"></div>

    <div class="steps">
      <span class="pill" id="pill-step1">STEP 1: 理由</span>
      <span class="pill" id="pill-step2">STEP 2: たとえば</span>
    </div>

    <div class="topic-head">
      <div class="topic-title" id="topicText"></div>
      <div class="topic-subline"><span>💡 正しい選択肢を選び、適切な <u>Body 1</u> を作ろう。</span></div>
    </div>

    <!-- STEP1 理由 -->
    <div id="reasonBlock" class="row" style="margin-top:8px">
      <div id="reasonArea" class="choice-wrap"></div>
      <div id="reasonMsg" class="muted"></div>
    </div>

    <!-- 理由＋STEP2 -->
    <div class="row" id="exampleBlock" style="margin-top:8px; display:none">
      <div id="reasonGroup" class="reason-group">
        <div id="reasonSummary" class="summary-line">
          <span class="tag">✓ 理由</span><span id="reasonPickedText"></span>
        </div>
        <div class="subhead">STEP 2｜この理由に合う <span style="text-decoration:underline">たとえば</span> を選ぼう</div>
        <div id="exampleArea" class="choice-wrap"></div>
      </div>
      <div id="exampleMsg" class="muted"></div>
    </div>

    <!-- Preview（下）＋ OKボタン群 -->
    <div class="row" id="previewBlock">
      <div class="preview">
        <div id="previewText"><b>Preview:</b><br>First, — because —.</div>
        <div class="preview-actions">
          <button id="btn-tts" class="btn-icon" aria-label="読み上げ">🎧</button>
          <details><summary>▶︎ オプション</summary>
            <label class="muted">速度 <input id="rate" type="range" min="0.7" max="1.3" step="0.1" value="1"></label>
          </details>
          <small id="ttsNote" class="muted"></small>
        </div>
      </div>
      <div class="okwrap" id="okWrap1">
        <span class="muted">これでいい？</span>
        <button id="btn-ok1" class="primary" disabled>OK（STEP 2へ）</button>
      </div>
      <div class="okwrap" id="okWrap2">
        <span class="muted">答え合わせ：</span>
        <button id="btn-ok2" class="primary" disabled>OK（次へ）</button>
      </div>
      <div id="result" class="muted">STEP 1 → STEP 2 の順に完成させよう</div>
    </div>
  </div>

  <div class="hr"></div>

  <!-- まとめ：チェックで選んでコピー／表示 -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div style="font-weight:700">📜 まとめ</div>
      <button id="btn-copy" class="secondary">📋 コピー</button>
    </div>
    <div class="muted" style="margin:.25rem 0 .5rem">コピーしたい問題にチェック✔︎（「表示」でその問題を再表示）</div>
    <div id="answersList" class="row"></div>
    <div id="answers" class="copy-area" aria-live="polite"></div>
  </div>
</div>

<script>
  /* ====== Config ====== */
  const CONFIG = { questionCount: 3, topicMode: 'auto', presetTopics: ['A','C','E'] };
  (function(){
    const sp = new URLSearchParams(location.search);
    const m = sp.get('topics');
    if(m){ CONFIG.topicMode = 'preset'; CONFIG.presetTopics = m.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean); }
  })();

  /* ====== Data（トピック別 5択） ====== */
  const BANK = {
    A:{topic:'Students should wear school uniforms.',
      reasons:[
        {id:'A-r1',text:'it saves time in the morning.',tag:'⏱ 朝の時間',correct:true,exId:'A-ex-iii'},
        {id:'A-r2',text:'it helps us focus.',tag:'🎧 集中',correct:true,exId:'A-ex-i'},
        {id:'A-r3',text:'it keeps us healthy.',tag:'💪 健康',correct:false},
        {id:'A-r4',text:'it gives us more energy.',tag:'⚡ 元気',correct:false},
        {id:'A-r5',text:'it speeds up research.',tag:'🔎 調べる速さ',correct:false},
      ],
      examples:[
        {id:'A-ex-i',text:'I can concentrate in class.'},
        {id:'A-ex-ii',text:"I don't feel sleepy in the morning."},
        {id:'A-ex-iii',text:"We don't waste time choosing clothes."},
        {id:'A-ex-iv',text:"I don't catch colds often."},
        {id:'A-ex-v',text:'We can look up information in seconds.'},
      ],
      why:'制服だと服えらびがいらず、見た目の差も小さくて気が散りにくい。'
    },
    B:{topic:'Eating vegetables is important.',
      reasons:[
        {id:'B-r1',text:'it keeps us healthy.',tag:'💪 健康',correct:true,exId:'B-ex-iv'},
        {id:'B-r2',text:'it gives us more energy.',tag:'⚡ 元気',correct:true,exId:'B-ex-ii'},
        {id:'B-r3',text:'it helps us focus.',tag:'🎧 集中',correct:false},
        {id:'B-r4',text:'it saves time in the morning.',tag:'⏱ 朝の時間',correct:false},
        {id:'B-r5',text:'it speeds up research.',tag:'🔎 調べる速さ',correct:false},
      ],
      examples:[
        {id:'B-ex-i',text:'I can stay focused in class.'},
        {id:'B-ex-ii',text:'I feel more awake in the morning.'},
        {id:'B-ex-iii',text:'We can get ready more quickly.'},
        {id:'B-ex-iv',text:'I rarely catch colds.'},
        {id:'B-ex-v',text:'We can look up information in seconds.'},
      ],
      why:'野菜は体の調子をととのえ、病気をへらす助けになる。'
    },
    C:{topic:'Going to bed early is a good habit.',
      reasons:[
        {id:'C-r1',text:'it gives us more energy.',tag:'⚡ 元気',correct:true,exId:'C-ex-ii'},
        {id:'C-r2',text:'it helps us focus.',tag:'🎧 集中',correct:true,exId:'C-ex-i'},
        {id:'C-r3',text:'it saves time in the morning.',tag:'⏱ 朝の時間',correct:false},
        {id:'C-r4',text:'it keeps us healthy.',tag:'💪 健康',correct:false},
        {id:'C-r5',text:'it speeds up research.',tag:'🔎 調べる速さ',correct:false},
      ],
      examples:[
        {id:'C-ex-i',text:'I can stay focused in class.'},
        {id:'C-ex-ii',text:'I feel more awake in the morning.'},
        {id:'C-ex-iii',text:'We can get ready more quickly.'},
        {id:'C-ex-iv',text:"I don't get sick often."},
        {id:'C-ex-v',text:'We can look up information in seconds.'},
      ],
      why:'早く寝ると次の朝に元気で、授業でも集中しやすい。'
    },
    D:{topic:'Using tablets in class is helpful.',
      reasons:[
        {id:'D-r1',text:'it speeds up research.',tag:'🔎 調べる速さ',correct:true,exId:'D-ex-v'},
        {id:'D-r2',text:'it helps us focus.',tag:'🎧 集中',correct:true,exId:'D-ex-i'},
        {id:'D-r3',text:'it saves time in the morning.',tag:'⏱ 朝の時間',correct:false},
        {id:'D-r4',text:'it keeps us healthy.',tag:'💪 健康',correct:false},
        {id:'D-r5',text:'it gives us more energy.',tag:'⚡ 元気',correct:false},
      ],
      examples:[
        {id:'D-ex-i',text:'I can concentrate in class.'},
        {id:'D-ex-ii',text:'I feel awake in the morning.'},
        {id:'D-ex-iii',text:'We can get ready more quickly.'},
        {id:'D-ex-iv',text:"I don't catch colds often."},
        {id:'D-ex-v',text:'We can look up information in seconds.'},
      ],
      why:'タブレットなら情報をすぐ調べられて、学習が進む。'
    },
    E:{topic:'Eating breakfast is important.',
      reasons:[
        {id:'E-r1',text:'it gives us more energy.',tag:'⚡ 元気',correct:true,exId:'E-ex-ii'},
        {id:'E-r2',text:'it keeps us healthy.',tag:'💪 健康',correct:true,exId:'E-ex-iv'},
        {id:'E-r3',text:'it helps us focus.',tag:'🎧 集中',correct:false},
        {id:'E-r4',text:'it saves time in the morning.',tag:'⏱ 朝の時間',correct:false},
        {id:'E-r5',text:'it speeds up research.',tag:'🔎 調べる速さ',correct:false},
      ],
      examples:[
        {id:'E-ex-i',text:'I can stay focused in class.'},
        {id:'E-ex-ii',text:'I feel more awake in the morning.'},
        {id:'E-ex-iii',text:'We can get ready more quickly.'},
        {id:'E-ex-iv',text:'I rarely catch colds.'},
        {id:'E-ex-v',text:'We can look up information in seconds.'},
      ],
      why:'朝ごはんでエネルギーが手に入り、体も元気になる。'
    }
  };
  const topicKeys = Object.keys(BANK);

  /* ====== Helpers ====== */
  const $ = s => document.querySelector(s);
  const el = (t,c) => { const e=document.createElement(t); if(c) e.className=c; return e; };
  const ensurePeriod = s => s.trim().replace(/[。．]$/,'').replace(/\.+$/,'') + '.';
  const cleanEnd = s => (s||'').replace(/[.。．]\s*$/,'');
  function sampleDistinct(arr, n){ const a=[...arr], out=[]; while(out.length<n && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }

  /* ====== State ====== */
  const state = { step:0, questions:[], score:0, selectedForCopy:{} };

  function initQuestions(){
    let picks;
    if(CONFIG.topicMode==='preset'){
      picks = CONFIG.presetTopics.slice(0, CONFIG.questionCount).filter(k=>topicKeys.includes(k));
      if(picks.length < CONFIG.questionCount){
        const rest = topicKeys.filter(k=>!picks.includes(k));
        picks = picks.concat(sampleDistinct(rest, CONFIG.questionCount-picks.length));
      }
    } else {
      picks = sampleDistinct(topicKeys, CONFIG.questionCount);
    }
    state.questions = picks.map(k=>({
      topic:k, pickedReason:null, pickedExample:null,
      reasonCorrect:false, exampleCorrect:false,
      confirmedStep1:false, _scored:false
    }));
    state.step = 0; state.score = 0; state.selectedForCopy = {};
  }

  /* ====== Render ====== */
  function render(){
    const q = state.questions[state.step];
    const bank = BANK[q.topic];
    $('#qnum').textContent = (state.step+1);
    $('#qtotal').textContent = state.questions.length;
    $('#score').textContent = state.score;
    $('#topicText').textContent = bank.topic;
    updateBar();

    renderReasonUI(q, bank);
    renderExampleUI(q, bank);
    updatePreview();
    updatePills();
    updateStepVisibility();
    updateOkButtons();
    renderAnswersList();

    $('#result').className='muted';
    $('#result').textContent='STEP 1 → STEP 2 の順に完成させよう';
  }

  function renderReasonUI(q, bank){
    const wrap = $('#reasonArea'); wrap.innerHTML='';
    bank.reasons.forEach((r,idx)=>{
      const chip = el('button','chip'); chip.type='button';
      chip.textContent = `${idx+1}. ${r.text}`;
      if(q.confirmedStep1){ chip.disabled = true; }
      if(q.pickedReason === r.id) chip.classList.add('selected');
      chip.addEventListener('click', ()=>{
        if(q.confirmedStep1) return;
        q.pickedReason = r.id;
        $('#reasonArea').querySelectorAll('.chip').forEach(b=>b.classList.remove('selected'));
        chip.classList.add('selected');
        $('#reasonMsg').textContent='';
        updatePreview(); updateOkButtons();
      });
      wrap.appendChild(chip);
    });
    $('#reasonMsg').textContent='';
  }

  function renderExampleUI(q, bank){
    const block = $('#exampleBlock'), wrap = $('#exampleArea'); wrap.innerHTML='';
    if(!q.confirmedStep1){ block.style.display='none'; return; }
    block.style.display='grid';
    bank.examples.forEach(ex=>{
      const chip = el('button','chip'); chip.type='button';
      chip.textContent = ex.text;
      if(q.pickedExample === ex.id) chip.classList.add('selected');
      if(q.exampleCorrect) chip.disabled = true;
      chip.addEventListener('click', ()=>{
        if(q.exampleCorrect) return;
        q.pickedExample = ex.id;
        $('#exampleArea').querySelectorAll('.chip').forEach(b=>b.classList.remove('selected'));
        chip.classList.add('selected');
        $('#exampleMsg').textContent=''; // まだ判定しない
        updatePreview(); updateOkButtons();
      });
      wrap.appendChild(chip);
    });
    $('#exampleMsg').textContent='';
  }

  /* PREVIEW（下）：選択部分を太字に */
  function updatePreview(){
    const q = state.questions[state.step];
    const bank = BANK[q.topic];

    const t0 = bank.topic;
    const rObj = q.pickedReason ? bank.reasons.find(x=>x.id===q.pickedReason) : null;
    const rTxt = rObj ? `<b>${escapeHTML(rObj.text)}</b>` : '—';
    const s1 = `First, ${escapeHTML(cleanEnd(t0))} because ${rTxt}`;
    let html = `<b>Preview:</b><br>${ensurePeriod(s1)}`;

    if(q.confirmedStep1){
      const exObj = q.pickedExample ? bank.examples.find(x=>x.id===q.pickedExample) : null;
      const exTxt = exObj ? `<b>${escapeHTML(exObj.text)}</b>` : '—';
      html += `<br>${ensurePeriod(`For example, ${exTxt}`)}`;
    }
    $('#previewText').innerHTML = html;
  }

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }

  /* STEP pills */
  function updatePills(){
    const q = state.questions[state.step];
    $('#pill-step1').className = 'pill ' + (q.confirmedStep1 ? 'done' : 'active');
    $('#pill-step2').className = 'pill ' + (q.confirmedStep1 ? (q.exampleCorrect ? 'done' : 'active') : '');
  }

  /* 可視制御 */
  function updateStepVisibility(){
    const q = state.questions[state.step];
    const bank = BANK[q.topic];
    if(q.confirmedStep1){
      $('#reasonBlock').style.display = 'none';
      const r = bank.reasons.find(x=>x.id===q.pickedReason);
      $('#reasonPickedText').textContent = `${r.text}（${r.tag}）`;
      $('#exampleBlock').style.display = 'grid';
      $('#reasonGroup').style.display = 'grid';
      $('#reasonSummary').style.display = 'flex';
    }else{
      $('#reasonBlock').style.display = 'grid';
      $('#exampleBlock').style.display = 'none';
      $('#reasonGroup').style.display = 'none';
    }
  }

  /* まとめ：チェックリスト */
  function renderAnswersList(){
    const box = $('#answersList'); box.innerHTML = '';
    state.questions.forEach((q,i)=>{
      const bank = BANK[q.topic];
      const row = el('div','ans-item'+(q.exampleCorrect?'':' disabled'));
      const left = el('label','ans-left');
      const cb = document.createElement('input'); cb.type='checkbox'; cb.disabled=!q.exampleCorrect;
      cb.checked = !!state.selectedForCopy[i];
      cb.addEventListener('change', ()=>{ state.selectedForCopy[i]=cb.checked; updateAnswersText(); });
      const title = el('span','ans-title'); title.textContent = `Q${i+1}`;
      const note = el('span','ans-note'); note.textContent = bank.topic;
      left.appendChild(cb); left.appendChild(title); left.appendChild(note);
      const showBtn = el('button','secondary slim'); showBtn.textContent='表示';
      showBtn.addEventListener('click', ()=>{
        state.step = i; render();
        document.getElementById('quiz').scrollIntoView({behavior:'smooth', block:'start'});
      });
      row.appendChild(left); row.appendChild(showBtn);
      box.appendChild(row);
    });
    updateAnswersText();
  }
  function buildAnswerText(q,i){
    const bank = BANK[q.topic];
    const r = bank.reasons.find(x=>x.id===q.pickedReason)?.text||'';
    const ex = bank.examples.find(x=>x.id===q.pickedExample)?.text||'';
    const s1 = ensurePeriod(`First, ${cleanEnd(bank.topic)} because ${cleanEnd(r)}`);
    const s2 = ensurePeriod(`For example, ${ex}`);
    return `Q${i+1}\n${s1}\n${s2}`;
  }
  function updateAnswersText(){
    const parts=[];
    state.questions.forEach((q,i)=>{
      if(state.selectedForCopy[i] && q.reasonCorrect && q.exampleCorrect){
        parts.push(buildAnswerText(q,i));
      }
    });
    $('#answers').textContent = parts.join('\n\n');
  }

  /* フィードバック */
  function flashBad(node){ node.classList.add('bad','flash'); setTimeout(()=>node.classList.remove('flash'), 600); }
  function explainWrongReason(topicKey, chosenReasonId){
    const bank = BANK[topicKey];
    const correctTags = bank.reasons.filter(r=>r.correct).map(r=>r.tag).join(' / ');
    const chosen = bank.reasons.find(r=>r.id===chosenReasonId);
    return `その理由だと話がずれるよ。${bank.why} だから、ポイントは ${correctTags}。今えらんだのは「${chosen.tag}」。もう一度考えよう。`;
  }
  function explainWrongExample(topicKey, pickedReasonId, pickedExampleId){
    const bank = BANK[topicKey];
    const belongTo = bank.reasons.find(r=>r.exId===pickedExampleId);
    const current = bank.reasons.find(r=>r.id===pickedReasonId);
    return `その例は「${belongTo?belongTo.tag:'別の理由'}」の話。今の理由は「${current.tag}」。つながっていないね。ヒント：例）${bank.examples.find(e=>e.id===current.exId)?.text}`;
  }

  /* ハンドラ */
  function confirmStep1(){
    const q = state.questions[state.step];
    const bank = BANK[q.topic];
    if(!q.pickedReason) return;
    const r = bank.reasons.find(x=>x.id===q.pickedReason);
    const ok = !!r?.correct;
    if(ok){
      q.reasonCorrect = true; q.confirmedStep1 = true;
      $('#reasonMsg').className='result ok';
      $('#reasonMsg').textContent='✅ 正解！STEP 2 へ進もう';
      updateStepVisibility(); renderExampleUI(q, bank);
      document.getElementById('exampleBlock').scrollIntoView({behavior:'smooth', block:'center'});
    }else{
      q.reasonCorrect=false; q.confirmedStep1=false;
      $('#reasonMsg').className='result bad';
      $('#reasonMsg').textContent=explainWrongReason(q.topic, q.pickedReason);
    }
    updatePreview(); updatePills(); updateOkButtons();
  }

  function confirmStep2(){
    const q = state.questions[state.step];
    const bank = BANK[q.topic];
    if(!q.pickedExample) return;
    const must = bank.reasons.find(r=>r.id===q.pickedReason)?.exId;
    const ok = (q.pickedExample === must);
    if(ok){
      q.exampleCorrect = true;
      if(!(q._scored)) { q._scored = true; state.score += 1; }
      $('#exampleMsg').className='result ok';
      $('#exampleMsg').textContent='✅ 正解！次の問題へすすむよ';
      renderAnswersList();
      setTimeout(()=> nextQuestion(), 900);
    }else{
      $('#exampleMsg').className='result bad';
      $('#exampleMsg').textContent=explainWrongExample(q.topic, q.pickedReason, q.pickedExample);
      // 不正解でもチップは残したまま・再選択可（正解は表示しない）
    }
    updatePreview(); updatePills(); updateOkButtons();
  }

  function nextQuestion(){
    if(state.step < state.questions.length-1){ state.step++; render(); }
    else { $('#result').className='result ok'; $('#result').textContent='🎉 すべて終了！おつかれさま'; }
  }

  function updateOkButtons(){
    const q = state.questions[state.step];
    // STEP1 OK
    const w1 = $('#okWrap1'), b1 = $('#btn-ok1');
    if(q.pickedReason && !q.confirmedStep1){ w1.style.display='flex'; b1.disabled=false; } else { w1.style.display='none'; b1.disabled=true; }
    // STEP2 OK（選択済みかつ未判定/未正解のとき表示）
    const w2 = $('#okWrap2'), b2 = $('#btn-ok2');
    if(q.confirmedStep1 && q.pickedExample && !q.exampleCorrect){ w2.style.display='flex'; b2.disabled=false; } else { w2.style.display='none'; b2.disabled=true; }
  }

  /* 初期化・バインド */
  initQuestions(); render();
  $('#btn-ok1').addEventListener('click', confirmStep1);
  $('#btn-ok2').addEventListener('click', confirmStep2);

  function updateBar(done=false){ const pct = done ? 100 : (state.step / state.questions.length) * 100; $('#bar').style.width = pct + '%'; }
  function resetAll(){ initQuestions(); render(); updateBar(); }
  $('#btn-reset').addEventListener('click', resetAll);
  $('#btn-print').addEventListener('click', ()=> window.print());
  $('#btn-copy').addEventListener('click', ()=>{ const t=$('#answers').textContent.trim(); if(!t) return; navigator.clipboard.writeText(t); });

  /* TTS */
  const tts = {
    supported:'speechSynthesis' in window, utter:null,
    get rate(){ return parseFloat($('#rate').value||'1'); },
    speak(text){ if(!this.supported) return; speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; u.rate=this.rate; const vs=speechSynthesis.getVoices(); const v=vs.find(v=>/en-|English/.test(v.lang||v.name)); if(v) u.voice=v; this.utter=u; speechSynthesis.speak(u); },
    stop(){ this.supported && speechSynthesis.cancel(); }
  };
  function previewPlainText(){ return $('#previewText').innerText.replace(/^Preview:\s*/,'').trim(); }
  const ttsBtn = $('#btn-tts');
  if(tts.supported){
    ttsBtn.addEventListener('click', ()=>{ if(!speechSynthesis.speaking){ tts.speak(previewPlainText()); } else { tts.stop(); } });
    $('#rate').addEventListener('input', ()=>{ if(speechSynthesis.speaking){ tts.speak(previewPlainText()); } });
  } else { $('#ttsNote').textContent='（ブラウザがTTSに非対応）'; ttsBtn.disabled = true; $('#rate').disabled = true; }
</script>
</body>
</html>
