<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ­£ã—ã„2æ–‡ã¥ãã‚Šã‚¯ã‚¤ã‚º</title>
<style>
  :root{ --bg:#f7f7fb; --card:#fff; --ink:#0f172a; --muted:#6b7280; --accent:#2563eb; --ring:#93c5fd; --ok:#16a34a; --bad:#dc2626; --radius:16px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,"Noto Sans JP",Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .container{max-width:900px;margin:0 auto;padding:clamp(16px,3vw,28px)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:10px}
  h1{font-size:clamp(20px,4.6vw,28px);margin:0}
  .toolbar{display:flex;gap:8px}
  button{border:0;background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.08)}
  button.secondary{background:#e5e7eb;color:#111827}
  button.primary{background:#2563eb;color:#fff}
  button.slim{padding:6px 10px;border-radius:10px;font-size:12px}
  button:focus{outline:2px solid var(--ring);outline-offset:2px}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#e0e7ff;color:#3730a3;font-weight:700;padding:4px 10px;border-radius:999px;font-size:12px}
  .muted{color:var(--muted)} .hr{height:1px;background:#e5e7eb;margin:12px 0}
  .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(2,6,23,.06)}
  .row{display:grid;gap:10px}
  .steps{display:flex;gap:6px;flex-wrap:wrap;margin:4px 0 2px}
  .pill{background:#eef2ff;color:#1e293b;font-weight:700;padding:3px 10px;border-radius:999px;font-size:12px}
  .pill.active{background:#2563eb;color:#fff}
  .pill.done{background:#dcfce7;color:#065f46}
  .choice-wrap{display:flex;flex-wrap:wrap;gap:8px}
  .chip{padding:10px 12px;border:1px solid #e5e7eb;border-radius:999px;cursor:pointer;background:#fff;transition:transform .08s ease, background .15s ease, border-color .15s ease;color:#111}
  .chip:hover{transform:translateY(-1px)}
  .chip[disabled]{opacity:.55;cursor:not-allowed;transform:none}
  .chip.selected{ outline:2px solid var(--accent); background:#eff6ff; border-color:#bfdbfe }

  .progress{height:6px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#2563eb);transition:width .25s ease}
  .result{font-weight:700}.result.ok{color:var(--ok)}.result.bad{color:var(--bad)}
  .copy-area{white-space:pre-wrap;background:#0b1020;color:#e2e8f0;padding:12px;border-radius:12px;font-size:14px}

  /* è¦‹å‡ºã—ï¼ˆç½«ç·šï¼‹é›»çƒï¼‰ */
  .topic-head{display:grid;gap:6px;margin-top:6px}
  .topic-title{font-weight:800;font-size:22px}
  .topic-subline{display:flex;align-items:center;gap:8px;color:#334155;font-weight:700}
  .topic-subline::before,.topic-subline::after{content:"";flex:1;height:1.5px;background:#e5e7eb;border-radius:999px}

  /* Previewï¼ˆä¸‹ï¼‰ */
  .preview{background:#f1f5f9;border-radius:12px;padding:12px;font-size:15px;margin-top:6px}
  .preview-actions{border-top:1px dashed #cbd5e1; margin-top:8px; padding-top:8px; display:flex; align-items:center; gap:12px; flex-wrap:wrap}
  .btn-icon{width:40px;height:40px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;background:#e5e7eb;color:#111827}

  .okwrap{display:none;align-items:center;gap:10px;margin-top:8px}

  /* STEP1ã®ç†ç”±ã‚’è¡¨ç¤ºã—ãªãŒã‚‰STEP2 */
  .reason-group{display:none;gap:8px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .summary-line{display:flex;align-items:center;gap:10px}
  .summary-line .tag{background:#dcfce7;color:#065f46;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .subhead{font-weight:700;color:#334155;font-size:14px;margin-top:2px}

  /* ã§ããŸæ–‡ï¼ˆã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ï¼‰ */
  .jumpbtn{display:flex;justify-content:space-between;align-items:center;width:100%;padding:10px 12px;border-radius:12px;background:#eef2ff;color:#1e293b;border:1px solid #dbeafe;cursor:pointer}
  .tag-ok{background:#dcfce7;color:#065f46;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
  .tag-ng{background:#fee2e2;color:#7f1d1d;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}

  @media print{ header,.toolbar,details{display:none!important} body{background:#fff} .card{box-shadow:none;border:1px solid #e5e7eb} }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ğŸŸ¨ æ­£ã—ã„2æ–‡ã¥ãã‚Šã‚¯ã‚¤ã‚º</h1>
    <div class="toolbar">
      <button id="btn-reset" class="secondary">â†º ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="btn-print" class="secondary">ğŸ–¨ï¸ å°åˆ·</button>
    </div>
  </header>

  <div class="progress"><div id="bar" class="bar"></div></div>

  <div id="quiz" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div class="badge">Q<span id="qnum">1</span> / <span id="qtotal">3</span></div>
      <div class="muted">æ­£è§£æ•°ï¼š<b id="score">0</b></div>
    </div>

    <div class="hr"></div>

    <div class="steps">
      <span class="pill" id="pill-step1">â‘  ç†ç”±ã‚’ãˆã‚‰ã¶</span>
      <span class="pill" id="pill-step2">â‘¡ ãŸã¨ãˆã°ã‚’ãˆã‚‰ã¶</span>
    </div>

    <div class="topic-head">
      <div class="topic-title" id="topicText"></div>
      <div class="topic-subline"><span>ğŸ’¡ æ­£ã—ã„ç†ç”±ã¨ã€ŒãŸã¨ãˆã°ã€ã‚’ãˆã‚‰ã‚“ã§ã€2æ–‡ã‚’å®Œæˆã•ã›ã‚ˆã†ã€‚</span></div>
    </div>

    <!-- STEP1 ç†ç”± -->
    <div id="reasonBlock" class="row" style="margin-top:8px">
      <div id="reasonArea" class="choice-wrap"></div>
      <div id="reasonMsg" class="muted"></div>
    </div>

    <!-- ç†ç”±ï¼‹STEP2 -->
    <div class="row" id="exampleBlock" style="margin-top:8px; display:none">
      <div id="reasonGroup" class="reason-group">
        <div id="reasonSummary" class="summary-line">
          <span class="tag">âœ“ ç†ç”±</span>
          <span id="reasonPickedText"></span>
          <button id="btn-edit-reason" class="slim secondary" type="button">ã‚„ã‚Šç›´ã™</button>
        </div>
        <div class="subhead">â‘¡ ã“ã®ç†ç”±ã«åˆã† <span style="text-decoration:underline">ãŸã¨ãˆã°</span> ã‚’ãˆã‚‰ã¼ã†</div>
        <div id="exampleArea" class="choice-wrap"></div>
      </div>
      <div id="exampleMsg" class="muted"></div>
    </div>

    <!-- ã§ããŸæ–‡ï¼ˆä¸‹ï¼‰ï¼‹ OK & æ¬¡ã¸ -->
    <div class="row" id="previewBlock">
      <div class="preview">
        <div id="previewText"><b>ã§ããŸæ–‡:</b><br>First, â€” because â€”.</div>
        <div class="preview-actions">
          <button id="btn-tts" class="btn-icon" aria-label="èª­ã¿ä¸Šã’">ğŸ§</button>
          <details><summary>èª­ã¿ä¸Šã’ã®ã¯ã‚„ã•</summary>
            <label class="muted">é€Ÿåº¦ <input id="rate" type="range" min="0.7" max="1.3" step="0.1" value="1"></label>
          </details>
          <small id="ttsNote" class="muted"></small>
        </div>
      </div>
      <div class="okwrap" id="okWrap1">
        <span class="muted">ã“ã‚Œã§ã„ã„ï¼Ÿ</span>
        <button id="btn-ok1" class="primary" disabled>ã“ã®æ–‡ã§OK</button>
      </div>
      <div class="okwrap" id="okWrap2">
        <span class="muted">ç­”ãˆã‚ã‚ã›ï¼š</span>
        <button id="btn-ok2" class="primary" disabled>OK</button>
      </div>
      <div class="okwrap" id="nextWrap">
        <button id="btn-next" class="secondary">ã¤ãã®å•é¡Œã¸</button>
      </div>
      <div id="result" class="muted">â‘  â†’ â‘¡ ã®é †ã«å®Œæˆã•ã›ã‚ˆã†</div>
    </div>
  </div>

  <div class="hr"></div>

  <!-- ã§ããŸæ–‡ï¼šã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ + ã‚³ãƒ”ãƒ¼ -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div style="font-weight:700">ğŸ“œ ã§ããŸæ–‡</div>
      <button id="btn-copy" class="secondary">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
    </div>
    <div id="jumpList" class="row" style="margin-top:6px"></div>
    <div id="answers" class="copy-area" aria-live="polite"></div>
  </div>
</div>

<script>
  /* ====== Config ====== */
  const CONFIG = { questionCount: 3, topicMode: 'auto', presetTopics: ['A','C','E'] };
  (function(){
    const sp = new URLSearchParams(location.search);
    const m = sp.get('topics');
    if(m){ CONFIG.topicMode = 'preset'; CONFIG.presetTopics = m.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean); }
  })();

  /* ====== Dataï¼ˆã”æŒ‡å®šã®25æ–‡ã«å®Œå…¨ä¸€è‡´ï¼‰ ====== */
  const BANK = {
    A:{topic:"Students should wear school uniforms.",
      reasons:[
        {id:'A-r1',text:"they save time in the morning.",tag:'â± æœã®æ™‚é–“',exId:'A-ex-1'},
        {id:'A-r2',text:"they help us focus on learning.",tag:'ğŸ§ é›†ä¸­',exId:'A-ex-2'},
        {id:'A-r3',text:"they can build a sense of school unity.",tag:'ğŸ¤ ä¸€ä½“æ„Ÿ',exId:'A-ex-3'},
        {id:'A-r4',text:"they can improve safety at school.",tag:'ğŸ›¡ å®‰å…¨',exId:'A-ex-4'},
        {id:'A-r5',text:"they can reduce pressure to wear trendy clothes.",tag:'âš– å…¬å¹³',exId:'A-ex-5'},
      ],
      examples:[
        {id:'A-ex-1', text:"we donâ€™t waste minutes choosing outfits."},
        {id:'A-ex-2', text:"we can concentrate in class instead of thinking about clothes."},
        {id:'A-ex-3', text:"we feel like one team when everyone wears the same outfit."},
        {id:'A-ex-4', text:"teachers can more easily spot people who donâ€™t go to our school."},
        {id:'A-ex-5', text:"we arenâ€™t teased for not wearing brand-name items."},
      ]
    },
    B:{topic:"Eating vegetables is important.",
      reasons:[
        {id:'B-r1',text:"they help keep our bodies healthy.",tag:'ğŸ’ª å¥åº·',exId:'B-ex-4'},
        {id:'B-r2',text:"they help us have steady energy when we eat them with grains and protein.",tag:'âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼',exId:'B-ex-2'},
        {id:'B-r3',text:"their fiber helps with digestion.",tag:'ğŸŒ€ æ¶ˆåŒ–',exId:'B-ex-3'},
        {id:'B-r4',text:"they support growth with vitamins and minerals.",tag:'ğŸ“ˆ æˆé•·',exId:'B-ex-1a'},
        {id:'B-r5',text:"they may lower the risk of getting sick.",tag:'ğŸ›¡ å…ç–«',exId:'B-ex-1'},
      ],
      examples:[
        {id:'B-ex-1',  text:"we tend to catch fewer colds in winter."},
        {id:'B-ex-2',  text:"we feel energetic in P.E. class when we eat vegetables with grains and protein."},
        {id:'B-ex-3',  text:"we donâ€™t get stomachaches as often after meals."},
        {id:'B-ex-4',  text:"we stay strong and balanced."},
        {id:'B-ex-1a', text:"we get enough nutrients such as vitamin C to grow well."},
      ]
    },
    C:{topic:"Going to bed early is a good habit.",
      reasons:[
        {id:'C-r1',text:"it generally gives me more energy in the morning.",tag:'âš¡ æœã®å…ƒæ°—',exId:'C-ex-1'},
        {id:'C-r2',text:"it helps me focus at school.",tag:'ğŸ§ é›†ä¸­',exId:'C-ex-2'},
        {id:'C-r3',text:"it helps improve my mood.",tag:'ğŸ˜Š æ©Ÿå«Œ',exId:'C-ex-3'},
        {id:'C-r4',text:"it helps my body grow and recover.",tag:'ğŸ“ˆ æˆé•·',exId:'C-ex-4'},
        {id:'C-r5',text:"it keeps me on a regular schedule.",tag:'â° ç”Ÿæ´»ãƒªã‚ºãƒ ',exId:'C-ex-5'},
      ],
      examples:[
        {id:'C-ex-1', text:"I wake up easily and feel fresh."},
        {id:'C-ex-2', text:"I can concentrate during the first period."},
        {id:'C-ex-3', text:"I donâ€™t get grumpy over small things."},
        {id:'C-ex-4', text:"I recover quickly after practice."},
        {id:'C-ex-5', text:"Iâ€™m not late because I sleep and wake at set times."},
      ]
    },
    D:{topic:"Using tablets in class is helpful.",
      reasons:[
        {id:'D-r1',text:"tablets can speed up research when internet access is available.",tag:'ğŸ” èª¿ã¹ã‚‹é€Ÿã•',exId:'D-ex-1'},
        {id:'D-r2',text:"they help us organize and find notes.",tag:'ğŸ—‚ æ•´ç†',exId:'D-ex-2'},
        {id:'D-r3',text:"they can make learning interactive with videos and apps.",tag:'â–¶ï¸ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–',exId:'D-ex-3'},
        {id:'D-r4',text:"they reduce daily paper use and can be more eco-friendly day to day.",tag:'ğŸŒ± ç’°å¢ƒ',exId:'D-ex-4'},
        {id:'D-r5',text:"they let us practice at our own level with learning apps.",tag:'ğŸ¯ å€‹åˆ¥å­¦ç¿’',exId:'D-ex-5'},
      ],
      examples:[
        {id:'D-ex-1', text:"we can find information in seconds."},
        {id:'D-ex-2', text:"we can search everything in one place."},
        {id:'D-ex-3', text:"we watch a short video to understand tough ideas."},
        {id:'D-ex-4', text:"we donâ€™t need to print many handouts."},
        {id:'D-ex-5', text:"we do quizzes that match our ability."},
      ]
    },
    E:{topic:"Eating breakfast is important.",
      reasons:[
        {id:'E-r1',text:"it helps me feel energized to start the day.",tag:'âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼',exId:'E-ex-1'},
        {id:'E-r2',text:"it helps me focus in morning classes.",tag:'ğŸ§ é›†ä¸­',exId:'E-ex-2'},
        {id:'E-r3',text:"it helps keep my mood more steady.",tag:'ğŸ™‚ æ©Ÿå«Œ',exId:'E-ex-3'},
        {id:'E-r4',text:"it can help keep my blood sugar steadier, depending on what I eat.",tag:'ğŸ’ª å¥åº·',exId:'E-ex-4'},
        {id:'E-r5',text:"it can help many people avoid overeating later.",tag:'ğŸ½ é£Ÿã¹éãé˜²æ­¢',exId:'E-ex-5'},
      ],
      examples:[
        {id:'E-ex-1', text:"I feel awake in the morning."},
        {id:'E-ex-2', text:"I can listen well in the first period."},
        {id:'E-ex-3', text:"I donâ€™t get angry just because Iâ€™m hungry."},
        {id:'E-ex-4', text:"I donâ€™t feel dizzy before P.E."},
        {id:'E-ex-5', text:"I donâ€™t eat too many snacks after school."},
      ]
    }
  };
  const topicKeys = Object.keys(BANK);

  /* â€”â€” ãƒãƒ©ãƒ³ã‚¹å‹ãƒ’ãƒ³ãƒˆï¼ˆç”˜ã•æ§ãˆã‚ï¼‰ï¼šè¦³ç‚¹ï¼‹å•ã„ã‹ã‘ â€”â€” */
  const HINT_BY_TAG = {
    'â± æœã®æ™‚é–“':'è¦³ç‚¹ï¼šæ™‚é–“çŸ­ç¸®ï¼ˆæœã®æº–å‚™ãŒæ—©ããªã‚‹ï¼‰',
    'ğŸ§ é›†ä¸­':'è¦³ç‚¹ï¼šé›†ä¸­åŠ›ï¼ˆæˆæ¥­ä¸­ã®æ³¨æ„ã®æŒç¶šï¼‰',
    'ğŸ¤ ä¸€ä½“æ„Ÿ':'è¦³ç‚¹ï¼šä¸€ä½“æ„Ÿï¼ˆä»²é–“æ„è­˜ãƒ»çµ±ä¸€æ„Ÿï¼‰',
    'ğŸ›¡ å®‰å…¨':'è¦³ç‚¹ï¼šå®‰å…¨æ€§ï¼ˆè¦‹åˆ†ã‘ã‚„ã™ã•ãƒ»ãƒªã‚¹ã‚¯ä½ä¸‹ï¼‰',
    'âš– å…¬å¹³':'è¦³ç‚¹ï¼šå…¬å¹³æ€§ï¼ˆæµè¡Œã‚„ãƒ–ãƒ©ãƒ³ãƒ‰ã®åœ§ã‚’ä¸‹ã’ã‚‹ï¼‰',
    'ğŸ’ª å¥åº·':'è¦³ç‚¹ï¼šå¥åº·ï¼ˆä½“èª¿ã®å®‰å®šãƒ»ç—…æ°—äºˆé˜²ï¼‰',
    'âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼':'è¦³ç‚¹ï¼šã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆæ´»å‹•ã®ãŸã‚ã®åŠ›ï¼‰',
    'âš¡ æœã®å…ƒæ°—':'è¦³ç‚¹ï¼šã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆæ´»å‹•ã®ãŸã‚ã®åŠ›ï¼‰', /* C-1 ç”¨ã«è¿½åŠ  */
    'ğŸŒ€ æ¶ˆåŒ–':'è¦³ç‚¹ï¼šæ¶ˆåŒ–ï¼ˆãŠè…¹ã®èª¿å­ãƒ»è² æ‹…ã®è»½ã•ï¼‰',
    'ğŸ“ˆ æˆé•·':'è¦³ç‚¹ï¼šæˆé•·ãƒ»å›å¾©ï¼ˆä½“ã¥ãã‚Šãƒ»ä¼‘é¤Šï¼‰',
    'ğŸ›¡ å…ç–«':'è¦³ç‚¹ï¼šå…ç–«ï¼ˆã‹ãœã‚’ã²ãã«ãã„ï¼‰',
    'ğŸ˜Š æ©Ÿå«Œ':'è¦³ç‚¹ï¼šæ„Ÿæƒ…ã®å®‰å®šï¼ˆã‚¤ãƒ©ã‚¤ãƒ©æ¸›å°‘ï¼‰',
    'ğŸ™‚ æ©Ÿå«Œ':'è¦³ç‚¹ï¼šæ„Ÿæƒ…ã®å®‰å®šï¼ˆã‚¤ãƒ©ã‚¤ãƒ©æ¸›å°‘ï¼‰',
    'â° ç”Ÿæ´»ãƒªã‚ºãƒ ':'è¦³ç‚¹ï¼šç”Ÿæ´»ãƒªã‚ºãƒ ï¼ˆæ±ºã¾ã£ãŸå°±å¯ãƒ»èµ·åºŠï¼‰',
    'â–¶ï¸ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–':'è¦³ç‚¹ï¼šå­¦ç¿’ã®ã‚„ã‚Šã¨ã‚Šï¼ˆå‹•ç”»ãƒ»ã‚¢ãƒ—ãƒªã§ç†è§£ï¼‰',
    'ğŸŒ± ç’°å¢ƒ':'è¦³ç‚¹ï¼šç’°å¢ƒé…æ…®ï¼ˆç´™è³‡æºã®ç¯€ç´„ï¼‰',
    'ğŸ—‚ æ•´ç†':'è¦³ç‚¹ï¼šæ•´ç†ãƒ»æ¤œç´¢ï¼ˆãƒãƒ¼ãƒˆãŒæ¢ã—ã‚„ã™ã„ï¼‰',
    'ğŸ¯ å€‹åˆ¥å­¦ç¿’':'è¦³ç‚¹ï¼šå€‹åˆ¥æœ€é©ï¼ˆè‡ªåˆ†ã®ãƒ¬ãƒ™ãƒ«ã«åˆã†ï¼‰',
    'ğŸ½ é£Ÿã¹éãé˜²æ­¢':'è¦³ç‚¹ï¼šé£Ÿè¡Œå‹•ï¼ˆã‚ã¨ã§é£Ÿã¹ã™ãã‚’é˜²ãï¼‰'
  };
  const HINT_Q_BY_TAG = {
    'â± æœã®æ™‚é–“':'ã‚ãªãŸã®ä¾‹ã¯ã€Œæœã®æº–å‚™ãŒæ—©ããªã‚‹ã€ã“ã¨ã‚’ã¯ã£ãã‚Šç¤ºã›ã¦ã„ã‚‹ï¼Ÿ',
    'ğŸ§ é›†ä¸­':'æˆæ¥­ä¸­ã«ã€Œæ³¨æ„ãŒãã‚Œã«ãã„ï¼ã‚ˆãèã‘ã‚‹ã€ã“ã¨ãŒä¼ã‚ã‚‹ï¼Ÿ',
    'ğŸ¤ ä¸€ä½“æ„Ÿ':'ã€Œã¿ã‚“ãªã§ã¾ã¨ã¾ã‚‹ãƒ»åŒã˜ä»²é–“ã ã¨æ„Ÿã˜ã‚‹ã€ã“ã¨ã‚’è¡¨ã—ã¦ã„ã‚‹ï¼Ÿ',
    'ğŸ›¡ å®‰å…¨':'ã€Œè¦‹åˆ†ã‘ã‚„ã™ããªã£ã¦å®‰å…¨ã«ãªã‚‹ã€ã“ã¨ã‚’èª¬æ˜ã§ãã¦ã„ã‚‹ï¼Ÿ',
    'âš– å…¬å¹³':'ã€Œæœã®é•ã„ã§æ¯”ã¹ã‚‰ã‚Œã«ãã„ã€ã“ã¨ãŒèª­ã¿å–ã‚Œã‚‹ï¼Ÿ',
    'ğŸ’ª å¥åº·':'ã€Œä½“èª¿ãŒå®‰å®šã™ã‚‹ï¼ç—…æ°—ã‚’ã¸ã‚‰ã™ã€æ ¹æ‹ ã«ãªã£ã¦ã„ã‚‹ï¼Ÿ',
    'âš¡ ã‚¨ãƒãƒ«ã‚®ãƒ¼':'ã€Œæ´»å‹•ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå‡ºã‚‹ã€ã“ã¨ã«ã¤ãªãŒã£ã¦ã„ã‚‹ï¼Ÿ',
    'âš¡ æœã®å…ƒæ°—':'ã€Œæ´»å‹•ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå‡ºã‚‹ã€ã“ã¨ã«ã¤ãªãŒã£ã¦ã„ã‚‹ï¼Ÿ',
    'ğŸŒ€ æ¶ˆåŒ–':'ã€ŒãŠè…¹ã®è² æ‹…ãŒè»½ããªã‚‹ï¼èª¿å­ãŒè‰¯ã„ã€ã‚’ç¤ºã—ã¦ã„ã‚‹ï¼Ÿ',
    'ğŸ“ˆ æˆé•·':'ã€Œä½“ã¥ãã‚Šã‚„å›å¾©ã€ã«é–¢ä¿‚ãŒã‚ã‚‹ï¼Ÿ',
    'ğŸ›¡ å…ç–«':'ã€Œã‹ãœã‚’ã²ãã«ãã„ã€ç†ç”±ã¨ã—ã¦è‡ªç„¶ï¼Ÿ',
    'ğŸ˜Š æ©Ÿå«Œ':'ã€Œæ°—åˆ†ãŒå®‰å®šã™ã‚‹ï¼ã‚¤ãƒ©ã‚¤ãƒ©ãŒæ¸›ã‚‹ã€ã‚’è¨€ãˆã¦ã„ã‚‹ï¼Ÿ',
    'ğŸ™‚ æ©Ÿå«Œ':'ã€Œæ°—åˆ†ãŒå®‰å®šã™ã‚‹ï¼ã‚¤ãƒ©ã‚¤ãƒ©ãŒæ¸›ã‚‹ã€ã‚’è¨€ãˆã¦ã„ã‚‹ï¼Ÿ',
    'â° ç”Ÿæ´»ãƒªã‚ºãƒ ':'ã€Œæ±ºã¾ã£ãŸæ™‚é–“ã«å¯èµ·ãã§ãã‚‹ã€ã“ã¨ã‚’ç¤ºã—ã¦ã„ã‚‹ï¼Ÿ',
    'â–¶ï¸ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–':'ã€Œå‹•ç”»/ã‚¢ãƒ—ãƒªã§ç†è§£ãŒæ·±ã¾ã‚‹ã€æµã‚Œã«ãªã£ã¦ã„ã‚‹ï¼Ÿ',
    'ğŸŒ± ç’°å¢ƒ':'ã€Œç´™ã‚’ä½¿ã‚ãªã„ï¼ç’°å¢ƒã«ã‚„ã•ã—ã„ã€èª¬æ˜ã«ãªã£ã¦ã„ã‚‹ï¼Ÿ',
    'ğŸ—‚ æ•´ç†':'ã€Œãƒãƒ¼ãƒˆã‚’ã¾ã¨ã‚ã‚„ã™ã„ãƒ»æ¢ã—ã‚„ã™ã„ã€ã‚’è¨€ãˆã¦ã„ã‚‹ï¼Ÿ',
    'ğŸ¯ å€‹åˆ¥å­¦ç¿’':'ã€Œè‡ªåˆ†ã®ãƒ¬ãƒ™ãƒ«ã«åˆã†ç·´ç¿’ãŒã§ãã‚‹ã€ä¾‹ã«ãªã£ã¦ã„ã‚‹ï¼Ÿ',
    'ğŸ½ é£Ÿã¹éãé˜²æ­¢':'ã€Œã‚ã¨ã§é£Ÿã¹ã™ããªã„ã€ã“ã¨ã¸ã¡ã‚ƒã‚“ã¨çµã³ã¤ãï¼Ÿ'
  };

  /* ====== Helpers ====== */
  const $ = s => document.querySelector(s);
  const el = (t,c) => { const e=document.createElement(t); if(c) e.className=c; return e; };
  const ensurePeriod = s => s.trim().replace(/[ã€‚ï¼]$/,'').replace(/\.+$/,'') + '.';
  const cleanEnd = s => (s||'').replace(/[.ã€‚ï¼]\s*$/,'');
  const esc = s => String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  const lowerFirst = s => s ? s.replace(/[A-Za-z]/, ch => ch.toLowerCase()) : s;
  function sampleDistinct(arr, n){ const a=[...arr], out=[]; while(out.length<n && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }

  /* ====== State ====== */
  const state = { step:0, questions:[], score:0 };

  function initQuestions(){
    let picks;
    if(CONFIG.topicMode==='preset'){
      picks = CONFIG.presetTopics.slice(0, CONFIG.questionCount).filter(k=>topicKeys.includes(k));
      if(picks.length < CONFIG.questionCount){
        const rest = topicKeys.filter(k=>!picks.includes(k));
        picks = picks.concat(sampleDistinct(rest, CONFIG.questionCount-picks.length));
      }
    } else {
      picks = sampleDistinct(topicKeys, CONFIG.questionCount);
    }
    state.questions = picks.map(k=>({
      topic:k, pickedReason:null, pickedExample:null,
      confirmedStep1:false, exampleCorrect:false, _scored:false,
      _exTries:0
    }));
    state.step = 0; state.score = 0;
  }

  /* ====== Render ====== */
  function render(){
    const q = state.questions[state.step];
    const bank = BANK[q.topic];
    $('#qnum').textContent = (state.step+1);
    $('#qtotal').textContent = state.questions.length;
    $('#score').textContent = state.score;
    $('#topicText').textContent = bank.topic;
    updateBar();

    renderReasonUI(q, bank);
    renderExampleUI(q, bank);
    updatePreview();
    updatePills();
    updateStepVisibility();
    updateOkButtons();
    renderJumpList();
    updateCopyBox();

    $('#result').className='muted';
    $('#result').textContent='â‘  â†’ â‘¡ ã®é †ã«å®Œæˆã•ã›ã‚ˆã†';
  }

  function renderReasonUI(q, bank){
    const wrap = $('#reasonArea'); wrap.innerHTML='';
    bank.reasons.forEach((r,idx)=>{
      const chip = el('button','chip'); chip.type='button';
      chip.textContent = `${idx+1}. ${r.text}`;
      if(q.confirmedStep1){ chip.disabled = true; }
      if(q.pickedReason === r.id) chip.classList.add('selected');
      chip.addEventListener('click', ()=>{
        if(q.confirmedStep1) return;
        q.pickedReason = r.id;
        $('#reasonArea').querySelectorAll('.chip').forEach(b=>b.classList.remove('selected'));
        chip.classList.add('selected');
        $('#reasonMsg').textContent='';
        updatePreview(); updateOkButtons();
      });
      wrap.appendChild(chip);
    });
    $('#reasonMsg').textContent='';
  }

  function renderExampleUI(q, bank){
    const block = $('#exampleBlock'), wrap = $('#exampleArea'); wrap.innerHTML='';
    if(!q.confirmedStep1){ block.style.display='none'; return; }
    block.style.display='grid';
    bank.examples.forEach(ex=>{
      const chip = el('button','chip'); chip.type='button';
      chip.textContent = ex.text;
      if(q.pickedExample === ex.id) chip.classList.add('selected');
      if(q.exampleCorrect) chip.disabled = true;
      chip.addEventListener('click', ()=>{
        if(q.exampleCorrect) return;
        q.pickedExample = ex.id;
        $('#exampleArea').querySelectorAll('.chip').forEach(b=>b.classList.remove('selected'));
        chip.classList.add('selected');
        $('#exampleMsg').textContent='';
        updatePreview(); updateOkButtons();
      });
      wrap.appendChild(chip);
    });
    $('#exampleMsg').textContent='';
  }

  /* ã§ããŸæ–‡ï¼ˆä¸‹ï¼‰ï¼šãƒˆãƒ”ãƒƒã‚¯å…ˆé ­å°æ–‡å­—åŒ–ï¼‹å¤ªå­—ï¼‹çµ‚æ­¢èª¿æ•´ */
  function updatePreview(){
    const q = state.questions[state.step];
    const bank = BANK[q.topic];
    const topicLower = lowerFirst(cleanEnd(bank.topic));
    const rObj = q.pickedReason ? bank.reasons.find(x=>x.id===q.pickedReason) : null;
    const stripEnd = s => (s||'').replace(/[.ã€‚ï¼]\s*$/,'');
    const rTxt = rObj ? `<b>${esc(stripEnd(rObj.text))}</b>` : 'â€”';

    let html = `<b>ã§ããŸæ–‡:</b><br>${ensurePeriod(`First, ${topicLower} because ${rTxt}`)}`;

    if(q.confirmedStep1){
      const exObj = q.pickedExample ? bank.examples.find(x=>x.id===q.pickedExample) : null;
      const exTxt = exObj ? `<b>${esc(stripEnd(exObj.text))}</b>` : 'â€”';
      html += `<br>${ensurePeriod(`For example, ${exTxt}`)}`;
    }
    $('#previewText').innerHTML = html;
  }

  /* STEP pills */
  function updatePills(){
    const q = state.questions[state.step];
    $('#pill-step1').className = 'pill ' + (q.confirmedStep1 ? 'done' : 'active');
    $('#pill-step2').className = 'pill ' + (q.confirmedStep1 ? (q.exampleCorrect ? 'done' : 'active') : '');
  }

  /* å¯è¦–åˆ¶å¾¡ + ã€Œã‚„ã‚Šç›´ã™ã€ãƒœã‚¿ãƒ³ */
  function updateStepVisibility(){
    const q = state.questions[state.step];
    const bank = BANK[q.topic];
    if(q.confirmedStep1){
      $('#reasonBlock').style.display = 'none';
      const r = bank.reasons.find(x=>x.id===q.pickedReason);
      $('#reasonPickedText').textContent = `${r.text}ï¼ˆ${r.tag}ï¼‰`;
      $('#exampleBlock').style.display = 'grid';
      $('#reasonGroup').style.display = 'grid';
      $('#reasonSummary').style.display = 'flex';
    }else{
      $('#reasonBlock').style.display = 'grid';
      $('#exampleBlock').style.display = 'none';
      $('#reasonGroup').style.display = 'none';
    }
    const editBtn = document.getElementById('btn-edit-reason');
    if(editBtn){
      editBtn.style.display = q.confirmedStep1 ? 'inline-flex' : 'none';
      editBtn.onclick = backToStep1;
    }
  }

  /* ã§ããŸæ–‡ï¼šã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã¨ã‚³ãƒ”ãƒ¼ï¼ˆå®Œæˆåˆ†ã®ã¿ï¼‰ */
  function renderJumpList(){
    const box = $('#jumpList'); box.innerHTML = '';
    state.questions.forEach((q,i)=>{
      const bank = BANK[q.topic];
      const btn = el('button','jumpbtn');
      const left = el('span'); left.textContent = `Q${i+1}: ${bank.topic}`;
      const right = el('span', q.exampleCorrect?'tag-ok':'tag-ng');
      right.textContent = q.exampleCorrect ? 'å®Œæˆ' : 'ã¾ã ';
      btn.appendChild(left); btn.appendChild(right);
      btn.addEventListener('click', ()=>{ state.step=i; render(); document.getElementById('quiz').scrollIntoView({behavior:'smooth', block:'start'}); });
      box.appendChild(btn);
    });
  }
  function buildAnswerText(q,i){
    const bank = BANK[q.topic];
    const r = bank.reasons.find(x=>x.id===q.pickedReason)?.text||'';
    const ex = bank.examples.find(x=>x.id===q.pickedExample)?.text||'';
    const topicLower = lowerFirst(cleanEnd(bank.topic));
    const s1 = ensurePeriod(`First, ${topicLower} because ${cleanEnd(r)}`);
    const s2 = ensurePeriod(`For example, ${cleanEnd(ex)}`);
    return `Q${i+1}\n${s1}\n${s2}`;
  }
  function updateCopyBox(){
    const parts=[];
    state.questions.forEach((q,i)=>{ if(q.confirmedStep1 && q.exampleCorrect){ parts.push(buildAnswerText(q,i)); } });
    $('#answers').textContent = parts.join('\n\n');
  }

  /* ãƒãƒ³ãƒ‰ãƒ© */
  function confirmStep1(){
    const q = state.questions[state.step];
    if(!q.pickedReason) return;
    q.confirmedStep1 = true;
    q._exTries = 0; // STEP2ã«å…¥ã‚‹ã®ã§ãƒªã‚»ãƒƒãƒˆ
    $('#reasonMsg').className='result ok';
    $('#reasonMsg').textContent='âœ… ã„ã„ã­ï¼ã¤ãã¯ã€ŒãŸã¨ãˆã°ã€';
    updateStepVisibility(); renderExampleUI(q, BANK[q.topic]);
    document.getElementById('exampleBlock').scrollIntoView({behavior:'smooth', block:'center'});
    updatePreview(); updatePills(); updateOkButtons();
  }

  function confirmStep2(){
    const q = state.questions[state.step];
    const bank = BANK[q.topic];
    if(!q.pickedExample) return;
    const must = bank.reasons.find(r=>r.id===q.pickedReason)?.exId;
    const ok = (q.pickedExample === must);
    if(ok){
      q.exampleCorrect = true;
      if(!(q._scored)) { q._scored = true; state.score += 1; }
      $('#exampleMsg').className='result ok';
      $('#exampleMsg').textContent='âœ… ã§ããŸï¼ã€Œã¤ãã®å•é¡Œã¸ã€ã¸';
      document.querySelectorAll('#exampleArea .chip').forEach(b=>b.disabled=true);
      updateCopyBox(); renderJumpList();
    }else{
      // â€”â€” è¦³ç‚¹ãƒ’ãƒ³ãƒˆ + 2å›ç›®ä»¥é™ã¯å•ã„ã‹ã‘ã€‚ãƒ©ãƒ™ãƒ«ï¼ˆçµµæ–‡å­—ã¤ãï¼‰ã‚‚æ˜ç¤º
      q._exTries = (q._exTries || 0) + 1;
      const current  = bank.reasons.find(r=>r.id===q.pickedReason);
      const belongTo = bank.reasons.find(r=>r.exId===q.pickedExample); // é¸ã‚“ã ä¾‹ãŒå±ã™ã‚‹ç†ç”±
      const currentLabel = current?.tag || 'åˆ¥ã®ç†ç”±';
      const chosenLabel  = belongTo?.tag || 'åˆ¥ã®ç†ç”±';
      const hint1 = HINT_BY_TAG[current?.tag] || 'è¦³ç‚¹ï¼šã“ã®ç†ç”±ã‚’ã¯ã£ãã‚Šç¤ºã™ä¾‹ã«ã—ã‚ˆã†ã€‚';
      const qHint = HINT_Q_BY_TAG[current?.tag] || '';
      $('#exampleMsg').className='result bad';
      $('#exampleMsg').textContent =
        q._exTries === 1
          ? `æƒœã—ã„ï¼ä»Šãˆã‚‰ã‚“ã å†…å®¹ã¯ã€${chosenLabel}ã€ã ã‚ˆã€‚ã€${currentLabel}ã€ã«é–¢é€£ã—ãŸå†…å®¹ã‚’é¸ã¼ã†ã€‚${hint1}`
          : `æƒœã—ã„ï¼ä»Šãˆã‚‰ã‚“ã å†…å®¹ã¯ã€${chosenLabel}ã€ã€‚ã­ã‚‰ã„ã¯ã€${currentLabel}ã€ã ã‚ˆã€‚${hint1} ${qHint}`;
    }
    updatePreview(); updatePills(); updateOkButtons();
  }

  function nextQuestion(){
    if(state.step < state.questions.length-1){ state.step++; render(); }
    else { $('#result').className='result ok'; $('#result').textContent='ğŸ‰ ã™ã¹ã¦çµ‚äº†ï¼ãŠã¤ã‹ã‚Œã•ã¾'; }
  }

  function backToStep1(){
    const q = state.questions[state.step];
    q.confirmedStep1 = false;
    q.pickedExample = null;
    q.exampleCorrect = false;
    q._exTries = 0;
    $('#exampleMsg').textContent = '';
    render();
    document.getElementById('reasonBlock').scrollIntoView({behavior:'smooth', block:'start'});
  }

  function updateOkButtons(){
    const q = state.questions[state.step];
    const w1 = $('#okWrap1'), b1 = $('#btn-ok1');
    if(q.pickedReason && !q.confirmedStep1){ w1.style.display='flex'; b1.disabled=false; } else { w1.style.display='none'; b1.disabled=true; }
    const w2 = $('#okWrap2'), b2 = $('#btn-ok2');
    if(q.confirmedStep1 && q.pickedExample && !q.exampleCorrect){ w2.style.display='flex'; b2.disabled=false; } else { w2.style.display='none'; b2.disabled=true; }
    $('#nextWrap').style.display = q.exampleCorrect ? 'flex' : 'none';
  }

  /* åˆæœŸåŒ–ãƒ»ãƒã‚¤ãƒ³ãƒ‰ */
  initQuestions(); render();
  $('#btn-ok1').addEventListener('click', confirmStep1);
  $('#btn-ok2').addEventListener('click', confirmStep2);
  $('#btn-next').addEventListener('click', nextQuestion);

  function updateBar(done=false){ const pct = done ? 100 : (state.step / state.questions.length) * 100; $('#bar').style.width = pct + '%'; }
  function resetAll(){ initQuestions(); render(); updateBar(); }
  $('#btn-reset').addEventListener('click', resetAll);
  $('#btn-print').addEventListener('click', ()=> window.print());
  $('#btn-copy').addEventListener('click', ()=>{ const t=$('#answers').textContent.trim(); if(!t) return; navigator.clipboard.writeText(t); });

  /* TTS */
  const tts = {
    supported:'speechSynthesis' in window, utter:null,
    get rate(){ return parseFloat($('#rate').value||'1'); },
    speak(text){ if(!this.supported) return; speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; u.rate=this.rate; const vs=speechSynthesis.getVoices(); const v=vs.find(v=>/en-|English/.test(v.lang||v.name)); if(v) u.voice=v; this.utter=u; speechSynthesis.speak(u); },
    stop(){ this.supported && speechSynthesis.cancel(); }
  };
  function previewPlainText(){
    return $('#previewText').innerText.replace(/^(Preview:|ã§ããŸæ–‡:)\s*/,'').trim();
  }
  const ttsBtn = $('#btn-tts');
  if(tts.supported){
    ttsBtn.addEventListener('click', ()=>{ if(!speechSynthesis.speaking){ tts.speak(previewPlainText()); } else { tts.stop(); } });
    $('#rate').addEventListener('input', ()=>{ if(speechSynthesis.speaking){ tts.speak(previewPlainText()); } });
    if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged === null) {
      speechSynthesis.onvoiceschanged = () => {};
    }
  } else {
    $('#ttsNote').textContent='ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãŒTTSã«éå¯¾å¿œï¼‰';
    ttsBtn.disabled = true; $('#rate').disabled = true;
  }
</script>
</body>
</html>
